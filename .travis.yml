sudo: true
language: python
cache: pip
python:
  - '3.7'
env:
  global:
    - AWS_DEFAULT_REGION=eu-west-1
    - AWS_DEFAULT_OUTPUT=json
    - DRIFT_TIER=DEVNORTH
    - DOCKER_TAG=$(git describe --tags --dirty --long)
    - PATH=$HOME/.local/bin:$PATH
    - BOTO_CONFIG=/dev/null
    - DRIFT_CONFIG_URL=s3://relib-test/directive-games
    - secure: j6i4ExM6NGvg0WCV0pB1YNhX1RqrjwtHprg346N9ElQAcPDCgJ9OY8AsrPCQwisTCHdNX045t0M0hTgklISbRWvoe/tkpL/Mz7nBfCGqmN2D/N+GXODsaReLbdiLqRicM23hY0srgpv8XeihbiGkVGnPBRc9aBtie2siTX/PvnL1DbYiWdEnGCGB1DrqdAWlLOliGphmsMPiXljWVVrx3JPqx9YyUnvr36POb+6q+Dn4Rb6EQ+C1v8a7rCKcHJT18R7MtwsjAvuFW7jV6s7N1cFCTUG/Ue9iLo+OOpQLqEdcKHVjjMdwrSazD26kWZeQnB5wkHYBBlG31ECPKCoBzlvh9MurwhPANHF7UR3EX5Wn1PJIBO0oTrvhTRicgnTmKg+iB1gdekxLCMxBX+cBj8p3hN6vQklCU+HJESjaV+vbSVvfH4arLY+2xlp3fOdXLHmd0GEnDOcnY3J9fNwh+PBONoKuzg91I5XKCqLKul6SYbObVpJtvIHW6MlnrQKnD/U4Dd+HeuzgtbrZKEoE1T5mlEJGjwAV+iGx3xttGpyEuLrPKtmwFEdFU5GLMqKgSKvLiqArHzfSBZ8sWrAUjNws5yCiy1tzI41XnQTxCWds/fS1MVkj3mCfqZiN5nK360wu0jR0K55Hfj2QRQ3+AiwjODFIvbGP9wS1IRyeNZ0=
    - AWS_ACCESS_KEY_ID=AKIAJRFN66GTACL66AZQ

drift_build_trigger:
  - drift
  - drift-config

jobs:
  include:
    # - stage: test
    #   services:
    #     - postgresql
    #     - redis-server
    #   install:
    #     - pip install pipenv --upgrade
    #     - pipenv install --dev --deploy
    #   script:
    #     - pytest --cov=driftbase/ --disable-warnings
    #   after_success:
    #     - codecov

    - stage: build
      services:
        - docker
      env:
        - DOCKER_REPO=drift-base
        - REGISTRY_URL=092475124519.dkr.ecr.eu-west-1.amazonaws.com
        - SOURCE_IMAGE=drift-base:${DOCKER_TAG}
        - TARGET_IMAGE="${REGISTRY_URL}/${SOURCE_IMAGE}"
      script:
        - docker build -t ${SOURCE_IMAGE} .
        - aws configure set default.region ${AWS_DEFAULT_REGION}
        - $(aws ecr get-login --no-include-email)
        - docker tag ${SOURCE_IMAGE} ${TARGET_IMAGE}
        - docker push ${TARGET_IMAGE}

    # - stage: deploy
    #   services:
    #     - docker
    #   install:
    #     - pip install "git+https://github.com/dgnorth/drift.git#egg=drift[aws,test]"
    #     - pip install "git+https://github.com/dgnorth/drift-config.git"
    #   script:
    #     - drift-admin --help
    #     #- drift-admin ami bake --skipcopy
    #     #- drift-admin ami run

# notifications:
#   on_pull_requests: false
#   slack:
#     secure: EAVUaNyoZoiRvanx8c4tOR0DLc1B8a4h5jxDTMzOfjZDi94bpXe2TjdKuWaGjjZf3Yt3uP3T9SP23QH2SnTD5CO6JnS7NoTSa9LOqa3cciw65niK3hW4eqNyn5/2fLNP+aA669Ta9V8t17GgINq4QerpVVW7biRzv2T61WVPUJavh9TD/rwyHO9nfq587nwqybWAJAiuzehimdTaZyZ47VRCwsEDmpAPctWH5NP1RBHuTXbbokr1/b2pQirIi9Gl+J7aCGFAr3jZBeK1ojdythHGRoIEI00vGkiHGZJ/GQN+BDX3sDRNXvHInEAXJ0si15I/KaFV1tP15YCRh28q+IDfvZnOIqGM8IFtFTXGrXLvn9UCHYwFgDybmvU3bzLEYmw+BFYwzJ4m5veOLwiQbYiqwnuv7AhRKsIAoa3LWH106w9edow7h+9NZUQvqzMBF6+6IltTB2oWGzQxrNqj+SyxRxe1L4VfO1uAt1ov+7k92jpBfEm1Pns8LQZJw2FpVAQ95U1K3qHvJ4ENkFdtbOOCxFRWhSxWFSdlAuxd7zjDDd1wf6k8LphPMNd7fuENM7X37eQwlewCgTZqtyMOjERaUcj6fLuWVT3gmcxxHKJkEVADzTYz+p02rO9Ju9CAwlurpcblgk1g8tyW/JQJaMMjRKaJvl3qz6R0xloyYQY=
#   email:
#     secure: aSsBzRiUwTWtAHZ2yqSQOQ7vhtWXulLNEbGWDVBhB5ZjiAKQXDNuKcVMTSkEYXwiVkTE8Jp+WtWCvPWivwwav9+yP5dp08NudGny1DNy2C18yQy6vJbOg3hGkaOTTly6DKSE0BL/a+JaoR67UiJ/0YS6V3z0ZA/rhMepNa1wG6217pLezvN2tcFzK/wbOZ8t0YEfrCBFKcQQelHBWCeFyF5W7uE6Ht5adukomu1/tqxLMCKkuBiT+uGY4YCoLnSAgPG2E1BuO2tEFWte2J6LRkofljAUZ6y4xeA0jO3epQYvrk7RbFs7VCtjDaBSfgQoE0waMyB5pCFG9tE0Q8n+KG/ZBjdNfjtBJ8Vv+1EvQROZEXgbLAbANFVcUl+hJ2iOsqzX3ecE2fZzByPZ5+Pj7KmlP+SuCVLbAir3AgB6T4iVQ+NHd0NRXcw97EGR4ZoSDRBQ+/oOor8fXIph2NfEnlkea/OJaXIxQWCnilNgu53bPNCN7Y2JmVrtkEEpYaIuZBrO1R2zby/Ltai50NZ9faTO1wp7IqOtM1PFGXfICzFdNiqSAZ26AYf9ZFv8SSpebl7uelBnwwe5rhpGK7FMa0GWAjd/av2hqbLKcooVPWcX3vUa726JPSU90+HuZHPyn0DaGzvA74e5SjT6tPJ53R4GapNamWMzteOB4Jh5PI4=
